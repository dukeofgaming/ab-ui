name: Create Feature Doc on Branch Creation

on:
  push:
    branches-ignore: 
      - main
      - develop
    
env:
  docs_dir: docs/

jobs:
  create-feature-doc:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get Github branch and issue number from Branch
        id: vars
        run: |
          BRANCH=$(git rev-parse --abbrev-ref HEAD | tr '/' '-')
          ISSUE_NUMBER=$(echo "$BRANCH" | sed -E 's/^([0-9]+)-.*$/\1/')

          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

          echo "Branch: $BRANCH" >> $GITHUB_STEP_SUMMARY
          echo "Issue Number: $ISSUE_NUMBER" >> $GITHUB_STEP_SUMMARY

      - name: Git Github Issue Details
        id: issue_details
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_BODY=$(gh \
            issue \
              view ${{ steps.vars.outputs.issue_number }} \
              --json body \
              | jq -r '.body'
          )

          # Get YAML frontmatter
          YAML_FRONTMATTER=$(echo "$ISSUE_BODY" \
            | sed -n '/^---$/,/^---$/p' \
            | sed '1d;$d'
          )

          ISSUE_TYPE=$(echo "$YAML_FRONTMATTER" | yq '.type')

          echo "issue_type=$ISSUE_TYPE" >> $GITHUB_OUTPUT
          echo "Issue Type: $ISSUE_TYPE" >> $GITHUB_STEP_SUMMARY

      - name: Fetch GitHub issue and create feature doc
        id: feature_doc
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          FILE_NAME=${{ steps.issue_details.outputs.issue_type }}-${{ steps.vars.outputs.issue_number }}.md
          
          FILE_DIRECTORY=${{ env.docs_dir }}/$(echo "${{ steps.issue_details.outputs.issue_type }}" | tr '[:upper:]' '[:lower:]')/${{ steps.vars.outputs.branch }}
          echo "file_directory=$FILE_DIRECTORY" >> $GITHUB_OUTPUT
          echo "file_name=$FILE_NAME" >> $GITHUB_OUTPUT
            
          # Check if filename without directory exists in repository
          FILE_PATH=$(find . -type f -name $FILE_NAME)

          if [ -n "$FILE_PATH" ]; then
            echo "## ðŸ“ Existing Documentation" >> $GITHUB_STEP_SUMMARY
            echo "File $FILE_PATH already exists, updating issue body." >> $GITHUB_STEP_SUMMARY
            
            gh issue edit \
              ${{ steps.vars.outputs.issue_number }} \
                --body-file "$FILE_PATH"

            echo "### ðŸ”— Related Issue" >> $GITHUB_STEP_SUMMARY
            echo "- [View Issue #${{ steps.vars.outputs.issue_number }}](https://github.com/${{ github.repository }}/issues/${{ steps.vars.outputs.issue_number }})" >> $GITHUB_STEP_SUMMARY

          else
            mkdir -p $FILE_DIRECTORY
            
            FILE_PATH=$FILE_DIRECTORY/$FILE_NAME
            
            echo "## ðŸ†• Creating Documentation" >> $GITHUB_STEP_SUMMARY
            echo "Creating new branch doc at \\`$FILE_PATH\\`" >> $GITHUB_STEP_SUMMARY

            ISSUE_BODY=$(gh \
              issue \
                view ${{ steps.vars.outputs.issue_number }} \
                --json body \
                | jq -r '.body'
            )
            echo "$ISSUE_BODY" > $FILE_PATH

          fi

          echo "file_path=$FILE_PATH" >> $GITHUB_OUTPUT

      - name: Commit and push feature doc
        if: steps.feature_doc
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ steps.feature_doc.outputs.file_path }}

          if ! git diff --cached --quiet; then
            git commit -m "[GITHUB] add feature doc for ${{ steps.vars.outputs.branch }}"
            git push

            echo "\n---" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸ“„ File Status" >> $GITHUB_STEP_SUMMARY
            echo "### âœ… Documentation added to branch \\`${{ steps.vars.outputs.branch }}\\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "\n---" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸ“„ File Status" >> $GITHUB_STEP_SUMMARY
            echo "### â„¹ï¸ No changes committed (documentation already up to date)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "\n---" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ Issue Details" >> $GITHUB_STEP_SUMMARY
          echo "- Issue Number: ${{ steps.vars.outputs.issue_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- Issue Type: ${{ steps.issue_details.outputs.issue_type }}" >> $GITHUB_STEP_SUMMARY

          echo "\n---" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“„ Documentation URL" >> $GITHUB_STEP_SUMMARY
          echo "- [View Documentation](https://github.com/${{ github.repository }}/blob/${{ steps.vars.outputs.branch }}/${{ steps.feature_doc.outputs.file_path }})" >> $GITHUB_STEP_SUMMARY
